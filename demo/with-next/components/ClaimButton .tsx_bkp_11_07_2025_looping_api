// components/ClaimButton.tsx
'use client';

import { useState, useEffect, useRef } from 'react';
import { useAccount } from 'wagmi';
import { toast } from 'react-toastify';

const ClaimButton = () => {
  const { address, isConnected } = useAccount();
  const [claimStatus, setClaimStatus] = useState({
    canClaim: false,
    lastClaimTime: null as number | null,
    timeLeft: ''
  });
  const [isClaiming, setIsClaiming] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  
  const isMounted = useRef(true);
  const userAddressRef = useRef<string | null>(null);
  const profileLoadedRef = useRef(false); // Usar ref para controlar carregamento

  useEffect(() => {
    return () => {
      isMounted.current = false;
    };
  }, []);

  // Carregar perfil do usu√°rio apenas uma vez
  useEffect(() => {
    if (profileLoadedRef.current) return;
    profileLoadedRef.current = true;
    
    console.log("üîî Iniciando carregamento do perfil");
    
    try {
      const storedProfile = localStorage.getItem('userProfile');
      if (storedProfile) {
        const profile = JSON.parse(storedProfile);
        console.log("üìù Perfil carregado:", profile);
        
        // Se j√° temos o endere√ßo no perfil, n√£o precisamos buscar
        if (profile.address) {
          console.log("‚úÖ Endere√ßo j√° dispon√≠vel no perfil:", profile.address);
          userAddressRef.current = profile.address;
          console.log("validando userAddresRef.current:", userAddressRef.current);
          
          // Marcar como carregado e verificar status
          setIsLoading(false);
          checkClaimStatus();
        } 
        // Se n√£o tem endere√ßo mas tem username, buscamos
        else if (profile.username) {
          console.log("üîç Buscando endere√ßo para username:", profile.username);
          fetchUserAddress(profile.username);
        }
      } else {
        setIsLoading(false);
      }
    } catch (error) {
      console.error("‚ùå Erro ao carregar perfil:", error);
      setIsLoading(false);
    }
  }, []);

  // Buscar endere√ßo associado ao username (apenas se necess√°rio)
  const fetchUserAddress = async (username: string) => {
    console.log("üåê Iniciando busca de endere√ßo para:", username);
    
    try {
      const response = await fetch(
        `https://usernames.worldcoin.org/api/v1/search/${username}`
      );
      
      if (!response.ok) {
        throw new Error(`Erro ${response.status}`);
      }
      
      const data = await response.json();
      console.log("üîç Resultado da busca:", data);
      
      const userData = data.find(
        (user: any) => user.username === username
      );
      
      if (userData) {
        console.log("‚úÖ Endere√ßo encontrado:", userData.address);
        userAddressRef.current = userData.address;
        
        // Atualizar perfil no localStorage
        const storedProfile = localStorage.getItem('userProfile');
        if (storedProfile) {
          const updatedProfile = JSON.parse(storedProfile);
          updatedProfile.address = userData.address; // Usar 'address' consistentemente
          localStorage.setItem('userProfile', JSON.stringify(updatedProfile));
        }
        
        // Verificar status ap√≥s obter endere√ßo
        checkClaimStatus();
      }
    } catch (error) {
      console.error("‚ùå Erro ao buscar endere√ßo:", error);
    } finally {
      setIsLoading(false);
    }
  };

  // Verificar status do claim
  const checkClaimStatus = async () => {
    const claimAddress = address || userAddressRef.current;
    console.log("üîç Verificando status para:", claimAddress);
    
    if (!claimAddress) {
      console.log("‚è≠Ô∏è Sem endere√ßo - pulando verifica√ß√£o");
      return;
    }
    
    try {
      console.log("üåê Chamando /api/check-claim...");
      const response = await fetch(
        `/api/check-claim?address=${encodeURIComponent(claimAddress)}`
      );
      
      console.log("üìä Resposta da API:", response.status);
      
      if (!response.ok) {
        throw new Error(`Erro ${response.status}`);
      }
      
      const data = await response.json();
      console.log("‚úÖ Dados recebidos:", data);
      
      if (isMounted.current) {
        setClaimStatus(prev => ({
          ...prev,
          canClaim: data.canClaim,
          lastClaimTime: data.lastClaimTime
        }));
        
        if (!data.canClaim && data.lastClaimTime) {
          console.log("‚è≥ Calculando tempo restante...");
          calculateTimeLeft(data.lastClaimTime);
        }
      }
    } catch (err) {
      console.error("‚ùå Erro ao verificar status:", err);
    }
  };

  // Calcular tempo restante
  const calculateTimeLeft = (lastTime: number) => {
    console.log("‚è±Ô∏è Calculando tempo restante a partir de:", new Date(lastTime));
    
    const now = Date.now();
    const nextClaimTime = lastTime + 24 * 60 * 60 * 1000;
    const difference = nextClaimTime - now;
    
    if (difference <= 0) {
      console.log("‚úÖ Tempo expirado - pode fazer claim");
      setClaimStatus(prev => ({
        ...prev,
        canClaim: true,
        timeLeft: ''
      }));
      return;
    }
    
    const hours = Math.floor(difference / (1000 * 60 * 60));
    const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((difference % (1000 * 60)) / 1000);
    
    const formattedTime = `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
    console.log("‚è≥ Tempo restante:", formattedTime);
    
    setClaimStatus(prev => ({
      ...prev,
      timeLeft: formattedTime
    }));
  };

  // Atualizar contador em tempo real
  useEffect(() => {
    if (!claimStatus.lastClaimTime || claimStatus.canClaim || !isMounted.current) {
      return;
    }
    
    console.log("‚è±Ô∏è Iniciando timer para atualiza√ß√£o");
    const timer = setInterval(() => {
      calculateTimeLeft(claimStatus.lastClaimTime!);
    }, 1000);
    
    return () => {
      console.log("üõë Parando timer");
      clearInterval(timer);
    };
  }, [claimStatus.lastClaimTime, claimStatus.canClaim]);

  // Verificar status quando o endere√ßo da carteira mudar
  useEffect(() => {
    if (userAddressRef.current && isMounted.current) {
      console.log("üîÑ Endere√ßo da carteira alterado - verificando status");
      checkClaimStatus();
    }
  }, [address]);

  const handleClaim = async () => {
    const claimAddress = address || userAddressRef.current;
    console.log("üéØ Iniciando claim para:", claimAddress);
    
    if (!claimAddress || isClaiming || !isMounted.current) return;
    
    setIsClaiming(true);
    
    try {
      const storedProfile = localStorage.getItem('userProfile');
      const username = storedProfile 
        ? JSON.parse(storedProfile).username 
        : `user_${claimAddress.slice(2, 8)}`;
      
      console.log("üì¶ Dados do claim:", { address: claimAddress, username });
      
      const response = await fetch('/api/claim', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          address: claimAddress, 
          username 
        })
      });
      
      console.log("üìä Resposta do claim:", response.status);
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Erro ao processar');
      }
      
      if (isMounted.current) {
        setClaimStatus(prev => ({
          ...prev,
          canClaim: false,
          lastClaimTime: Date.now()
        }));
      }
      toast.success('1 CR7 token successfully claimed!');
    } catch (err) {
      console.error('‚ùå Erro ao fazer claim:', err);
      toast.error('Falha ao reivindicar token');
    } finally {
      if (isMounted.current) {
        setIsClaiming(false);
      }
    }
  };

  if (isLoading) {
    console.log("‚è≥ Renderizando estado de carregamento");
    return (
      <div className="flex justify-center">
        <div className="animate-pulse bg-gray-200 rounded-lg w-32 h-10" />
      </div>
    );
  }

  const isUserConnected = isConnected || userAddressRef.current !== null;
  console.log("üîå Usu√°rio conectado:", isUserConnected);
  
  if (!isUserConnected) {
    console.log("üö´ Usu√°rio n√£o conectado - n√£o renderizando");
    return null;
  }

  console.log("üé® Renderizando componente:", claimStatus);

  return (
    <div className="w-full">
      {claimStatus.canClaim ? (
        <button
          onClick={handleClaim}
          disabled={isClaiming}
          className="
            bg-white
            text-green-600
            font-bold
            py-3
            px-6
            rounded-lg
            border-2
            border-green-500
            shadow-sm
            hover:bg-gray-50
            transition-colors
            duration-200
            disabled:opacity-70 
            disabled:cursor-not-allowed
            w-full
            flex
            items-center
            justify-center
          "
        >
          {isClaiming ? (
            <>
              <svg className="animate-spin h-5 w-5 mr-2 text-green-600" viewBox="0 0 24 24">
                <circle
                  className="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  strokeWidth="4"
                  fill="none"
                ></circle>
                <path
                  className="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              Processando...
            </>
          ) : (
            'CLAIM 1 CR7'
          )}
        </button>
      ) : claimStatus.timeLeft ? (
        <div className="text-center">
          <p className="text-white font-medium">Next claim in: {claimStatus.timeLeft}</p>
        </div>
      ) : (
        <div className="text-center">
          <p className="text-white font-medium">Verifying status...</p>
        </div>
      )}
    </div>
  );
};

export default ClaimButton;
